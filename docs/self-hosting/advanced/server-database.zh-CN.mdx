# 使用服务端数据库部署

LobeChat 默认使用客户端数据库（IndexedDB），同时也支持使用服务端数据库。LobeChat 采用了 Postgres 作为后端存储数据库。【需要一个 Postgres 简介，50字左右】

本文将详细介绍如何在 Vercel 中部署服务端数据库版 LobeChat，包括： 1）数据库配置；2）身份验证服务配置；3） S3 存储服务的设置步骤。

<Callout type={'info'}>
  限于工作量原因，目前仅支持在 Vercel 中部署使用服务端数据库版本，Docker 版本将会在后续迭代中支持。
</Callout>

## 一、 配置数据库

<Steps>

### 准备服务端数据库实例，获取连接 URL

在部署之前，请确保你已经准备好 Postgres 数据库实例，你可以选择以下任一方式：

- `A.` 使用 Vercel / Neon 等 Serverless Postgres 实例；
- `B.` 使用 Docker 等自部署 Postgres 实例。

两者的配置方式略有不同，在下一步会有所区分。

### 在 Vercel 中添加环境变量

在 Vercel 的部署环境变量中，添加 `DATABASE_URL` 等环境变量，将上一步准备好的 Postgres 数据库连接 URL 填入其中。数据库连接 URL 的通常格式为 `postgres://username:password@host:port/database`。

  <Tabs items={['Serverless Postgres', 'Node Postgres']}>

    <Tab>

      Serverless Postgres 需要填写的变量如下：

      ```env
      # Serverless Postgres DB Url
      DATABASE_URL=

      # 指定 service mode 为 server，否则不会进入服务端数据库
      NEXT_PUBLIC_SERVICE_MODE=server
      ```

      在 Vercel 中填写的示例如下：

      <Image alt={'添加 Serverless Postgres DATABASE_URL'} src={'https://github.com/lobehub/lobe-chat/assets/28616219/d4a710cd-6404-4196-90d0-cd08ca385074'}></Image>

</Tab>

    <Tab>
      Node Postgres 需要填写的变量如下：

      ```env
      # Node Postgres DB Url
      DATABASE_URL=

      # 指定 Postgres database driver 为 node
      DATABASE_DRIVER=node

      # 指定 service mode 为 server，否则不会进入服务端数据库
      NEXT_PUBLIC_SERVICE_MODE=server
      ```

      在 Vercel 中填写的示例如下：

      <Image alt={'添加 Node Postgres DATABASE_URL'} src={'https://github.com/lobehub/lobe-chat/assets/28616219/1c689738-809b-4199-b305-ba5770d39da7'}></Image>

</Tab>

</Tabs>

</Steps>

## 二、 配置身份验证服务

服务端数据库需要搭配用户身份验证服务才可以正常使用。因此需要配置对应的身份验证服务。

<Callout type={'warning'}>
  同样由于工作量原因，目前仅支持 Clerk 作为身份验证服务方案， Next-Auth 的服务端数据库集成有待开发
</Callout>

<Steps>

### 准备 Clerk 身份验证服务

前往 [Clerk](https://clerk.com?utm_source=lobehub&utm_medium=docs) 注册并创建应用，获取相应的 Public Key 和 Secret Key。

<Callout type={'info'}>
  如果对 Clerk 不太了解，可以查阅
  [身份验证服务-Clerk](/zh/docs/self-hosting/advanced/authentication#clerk) 了解 Clerk 的使用详情。
</Callout>

### 在 Vercel 中添加公、私钥环境变量

在 Vercel 的部署环境变量中，添加 `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` 和 `CLERK_SECRET_KEY` 环境变量。你可以在菜单中点击「API Keys」，然后复制对应的值填入 Vercel 的环境变量中。

<Image
  alt={'在 Clerk 中找到对应的公私钥环境变量'}
  src={'https://github.com/lobehub/lobe-chat/assets/28616219/89883703-7a1a-4a11-b944-5d804544e57c'}
></Image>

此步骤所需的环境变量如下：

```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_xxxxxxxxxxx
CLERK_SECRET_KEY=sk_live_xxxxxxxxxxxxxxxxxxxxxx
```

添加上述变量到 Vercel 中：

<Image
  alt={'在 Vercel 中添加 Clerk 公私钥环境变量'}
  src={'https://github.com/lobehub/lobe-chat/assets/28616219/2bfa13df-6e20-4768-97c0-4dad06c85a2f'}
></Image>

### 在 Clerk 中创建并配置 Webhook

由于我们让 Clerk 完全接管用户鉴权与管理，因此我们需要在 Clerk 用户生命周期变更时（创建、更新、删除）中通知我们的应用并存储落库。我们通过 Clerk 提供的 Webhook 来实现这一诉求。

我们需要在 Clerk 的 Webhooks 中添加一个端点（Endpoint），告诉 Clerk 当用户发生变更时，向这个端点发送通知。

<Image
  alt={'Clerk 添加 Webhooks 端点'}
  src={'https://github.com/lobehub/lobe-chat/assets/28616219/f50f47fb-5e8e-4930-bf4e-8cf6f5b8afb9'}
></Image>

在 endppint 中填写你的 Vercel 项目的 URL，如 `https://your-project.vercel.app/api/webhooks/clerk`。然后在订阅事件（Subscribe to events）中，勾选 user 的三个事件（`user.created` 、`user.deleted`、`user.updated`），然后点击创建。

<Image
  alt={'添加 Clerk Webhooks 时，配置 URL 和用户事件'}
  src={'https://github.com/lobehub/lobe-chat/assets/28616219/0249ea56-ab17-4aa9-a56c-9ebd556c2645'}
></Image>

### 将 Webhook 秘钥添加到 Vercel 环境变量

创建完毕后，可以在右下角找到该 Webhook 的秘钥：

<Image
  alt={'查看 Clerk Webhooks 秘钥'}
  src={'https://github.com/lobehub/lobe-chat/assets/28616219/fab4abb2-584b-49de-9340-813382951635'}
></Image>

  将这个秘钥所对应的环境变量名为 `CLERK_WEBHOOK_SECRET`，将其添加到 Vercel 的环境变量中：

  ```env
  CLERK_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxxxxxxxx
  ```

  <Image
    alt={'在 Vercel 中 添加 Clerk Webhooks 秘钥'}
    src={'https://github.com/lobehub/lobe-chat/assets/28616219/5fdc9479-007f-46ab-9d6e-a9603e949116'}
  ></Image>

</Steps>

## 三. 配置 S3 存储服务

LobeChat 在很早以前就支持了多模态 的 AI 会话，其中涉及到图片上传给 AI 的功能点。在客户端数据库方案中，图片文件是直接以二进制数据存储在本地数据库中的。但在服务端数据库中这个方案不可行。因此我们需要配置 S3 存储服务来存储图片文件。

  <Steps>

请确保你已经配置好 S3 存储

1. 前往你的 S3 服务提供商（如 AWS S3、Cloudflare R2 等）并创建一个新的存储桶（Bucket）。
2. 获取 `S3_ACCESS_KEY_ID` 和 `S3_SECRET_ACCESS_KEY`。
3. 设置存储桶的域名（`NEXT_PUBLIC_S3_DOMAIN`）和终端节点（`S3_ENDPOINT`）。
4. 将这些值填入 `.env` 文件中的相应字段。

</Steps>

### 3. 配置 S3

如果你的应用需要上传图片，请确保你已经配置好 S3 存储，并将 `NEXT_PUBLIC_S3_DOMAIN`、`S3_ACCESS_KEY_ID`、`S3_SECRET_ACCESS_KEY`、`S3_ENDPOINT` 和 `S3_BUCKET` 填入 `.env` 文件。

**步骤：**

### 4. 部署到 Vercel

**步骤：**

1. 确保你已经将 LobeChat 项目代码推送到 GitHub 仓库。
2. 访问 [Vercel](https://vercel.com) 并登录。
3. 点击 “New Project” 并选择你的 GitHub 仓库。
4. 在项目设置中，添加环境变量，将 `.env` 文件中的配置逐项添加到 Vercel 的环境变量设置中：

- 前往 Vercel 项目的 “Settings” 页面。
- 点击 “Environment Variables”。
- 逐项添加 `.env` 文件中的每个变量及其值。

5. 点击 “Deploy” 按钮，Vercel 将自动开始部署你的项目。

### 5. 验证部署

部署完成后，访问你的 Vercel 项目 URL，确保应用能够正常运行。如果遇到任何问题，请检查 Vercel 的日志输出，并根据提示进行修复。

**步骤：**

1. 部署完成后，访问 Vercel 分配的项目 URL。
2. 检查应用的各项功能是否正常运行，如数据库连接、用户身份验证和图片上传等。
3. 如遇到问题，前往 Vercel 项目的 “Logs” 页面查看详细的错误日志。

至此，你已经成功在 Vercel 上部署了 Server 版 LobeChat。如果你有任何问题或建议，欢迎在 GitHub 仓库中提出讨论。

## 服务端数据库所需环境变量

请先准备好以下环境变量配置：

```env
# Postgres 数据库 URL
DATABASE_URL=

# 指定服务模式为 server
NEXT_PUBLIC_SERVICE_MODE=server

# Clerk 相关配置
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=
CLERK_SECRET_KEY=
CLERK_WEBHOOK_SECRET=

# S3 相关配置（上传图片必须）
NEXT_PUBLIC_S3_DOMAIN=
S3_ACCESS_KEY_ID=
S3_SECRET_ACCESS_KEY=
S3_ENDPOINT=
S3_BUCKET=
```
